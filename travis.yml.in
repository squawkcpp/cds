sudo: required 
language: cpp
services:
  - docker
before_install:
  - mkdir $(pwd)/build
  - docker pull spielhuus/buildimage:latest
  - sudo docker run -itd --name build -v $(pwd)/cds:/repo -v $(pwd)/build:/build spielhuus/buildimage
  - sudo docker exec build apt-get -y update
  - sudo docker exec build apt-get -y install libsdl2-dev libboost-all-dev libao-dev libimlib2-dev libsqlite3-dev libxml++-dev libpcre++-dev libxml2-dev libmp3lame-dev libflac++-dev libpoppler-cpp-dev libcurl4-openssl-dev libcurlpp-dev libzmq-dev libsigc++-2.0-dev libssl-dev libarchive-dev uuid-dev libhiredis-dev libev-dev libmagic-dev libopencv-dev libmusicbrainz5-dev libavcodec-dev libavdevice-dev libavfilter-dev libavformat-dev libavresample-dev libavcodec-extra
  - sudo docker exec build git clone https://github.com/squawkcpp/cds.git /repo
script:
  - sudo docker exec build cmake -H/repo -B/build
  - sudo docker exec build cmake --build /build
  - sudo docker exec build /build/test_cds
  - sudo docker exec build cmake --build /build --target package

deploy:
  provider: releases
  api_key:
    secure: "PkcR+VgR0PzvGC+hc3SJPvUPjpV1juZAzMYOGi+Ez9Rgwuf06a5RAOHPnWwJ230ocEqGV6HQW/scufSZpahTpvB4e28nzoJSBcdmjWhNmy3NzENeseu6NgzhwJXtkfFYhMpoBTtT0E295CIvjY7PwvWG3oxhuzIfmMBHobKkGjJc8rQfGqhlzrYpja59luX4CqKVFasBRRGyeMaQ/zM6Ng9AKz23XwBUF7esyqwjPxbqFwrAgnn1ZL/PosCb2yb8GVuRl5/J0mSfLUxAeJ+T5z9Z4FLyeSWdzrKvNwFiOrPUAR/rC0hFqgYJOO7Bgf6wmF9uCLv6pfc/l/l9Y3FgERfDn8P3ijoixv9cQm8LkL2H1ysf0e+l/d0MlahZ2YMr5rZWKk29jZdBto7ceA0USXh4Ql+lsJHci4Yt9wm5RAZXn1fJKRMeahKIxwCuAIpDMGeTWnSmc42Y3meoAtIZNi8O481FGSo6n6xSOccMxqhnjZE+NGjvPOFSBZgy4Da0WnHZoSALFfDQGvExVEVPYTurltTlLNUUsPQk1W6qFPEMpDNZ0x77lIx0uhEWgj8gaIlHt00KhEAyUIWOAQm9WIqipyy/MmXN9SwdaQdwIxWBadGh4hft1zx6cBoyuBv51Bz5bdbldoKicrExMYqWmGveJdCzTFDCqmg3gC+HpEs="
  file: '$(pwd)/build/cds_@CDS_TAG_VERSION@.deb'
  skip_cleanup: true
  on:
    tags: true
    all_branches: true
    repo: squawkcpp/cds

after_success:
  - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
  - export REPO=squawkcpp/cds
  - export TAG=`if [ "$TRAVIS_BRANCH" == "master" ]; then echo "latest"; else echo $TRAVIS_BRANCH ; fi`
  - docker build -f Dockerfile -t $REPO:$COMMIT .
  - docker tag $REPO:$COMMIT $REPO:$TAG
  - docker tag $REPO:$COMMIT $REPO:travis-$TRAVIS_BUILD_NUMBER
  - docker push $REPO

env:
  global:
    - secure: "PI51PIbYZcLyqgSa0j1Q5+WmKFlV8Q0FxL+7uMvCUN564tdhhOtV/rGP5pSCjwIRHQwfY5fj8rZ4QYFPAWwnOQS9RoCUVGFz7u+6c8UbHS+AxqQLGfY+pkvHJ7a9XXScvXUJ73Iu2HcOS6gxgk9KbKihm+zpIKfia0kr4lresTZiBpK2t5T1yMWCfMIxisWGM8Wesin7A+/jQj3MdOz86++Evzkn+YQncgkBD4rXvDIJB9uO8SSKU2kr5MYi54OI+AvLcHm3xx3l3uW6l7rnhif7DC43V4dkfoqknMgAibOGI/Wv5qA0Z+xNh9qpKY4qzTTOt7OwOFSvy6CDd5tLjtmJgP8tetTV6jTw0t4/+IPDrqnRgc/vFDGS761OlWbMlMeCMdPKCrNGFo6/Sw5k+h9wKqs8NaLbnV699OlhcaeQiatOU2plwvZAcUKLMgpSq74joWHohDXjO1GC+OBLBAO6v7hHAiyW2eyIl8MMLMB1i4O9mjnrH/SGMn5ui7JluDZu38EcQsDidbcKajzy3Xxu5slqXzjO/8XuBjE+OOVA2eStxFGZNPDPC1NWzHFmr8I9sETSUu6Mr+EUQSlO1R6keu0BKlHGhkxlRfuK4/inRJ6AqetdjmQepKb1+Tu7M3cu8Wcf1Rakt0/XBd8WK87qmXRZpLbPcVL4z15DekQ=" # DOCKER_EMAIL
    - secure: "R5XUI+6fdGGnIGE+DMBdzLaIx+ckapHTloFV4h2wa85lIcYH1AroJ3ikpnV8Vssb1SJgm3UpHtTMMiXmpEGof53WeA68JfCdesdH3hhJU2yEyTZ+1zyCIEdop1PsDwhT8xWr/GhoM3d+Ncd3CZYI9k3fsK75yJpi6YNlIrYzt/VolrnR3Yel/2tjyYq8MZ484cPuHNfqSmdYPeygUMfrLCB84TGTmvwxFfu+njstjd1GSGC3vkQPrLjsCcvcFS223vXpW/L53S3D7nHSE/vh5zJeEUdJQwkYme49okUGsQCwyPLcmGst1Q/0E4b1SlMst877gdCJlFTMldPelB8hd0njqpAZ6eSvdHV8je8PeCd4OHUej0VTEI2NJURi825iY7TSoEfotJ0IrFWhwz489ubP1EMq5yljmSWAzuTSKUPZKqmrqKEEGNuweH6uhEVVQg45nKElGBm8ERV85jUX9KNoBp7d5a5sXBGFzqGgM+zSHj9nVhzH3hHaL47xaOaTxAnwxGjnItKmeZ1CasaThhyRTuuuR19jhgoFInGpTgRKvxdISnCzHeA5ZnK828HIPickNaZskBMdKlKF7095D+ay2f/WrUkLSLAJ7NvV1Y3cPSTF5yzVRRU99vVl+F4Myrr3W0L+wyybYcTL252HZ37r0YxQ2Sds52n+tQlQD/k=" # DOCKER_USER
    - secure: "YZsjKNCh4z3rfZ4kwbFDNJqE0txSnFde1oSmmb7a2dJpPC0HLZzGd5FasSxLL8v2wU2QKeHe6obDhbc8VVKqDSz6KtGs28EojfyYnAoLimEGtK5pdThNrb4AFtBqm3aVc8b0sZBgyFxV8mxlrDHlKjzuBrjIvrnCcXVJccypZch56ds7ibWZabXzCE/HXSgGz2Yf7KXhha1Hw2lbho/8haVnP4yrILV2fhRtC2T6MyamhrXlQVZSY6poFhZUT9fB4LPDVv2FuGlgokZ8U8U9Jk+xM691YRvJzHEt0y0OObpLCmO67wDN/S1cbQEu4hdDXoKgiVe0YLCj7kuEh1A4BgIZPGe1hRbEPx9aVpZEutSdKgVlVnj8KrtY3KKaIcmS+1zo6I3qtcapFTrsNFzBiawEOKOoRToojfAEY6IM6WgpCg3CbhOGuTjBF46z76nFkTzciMa88lJ8GIXKkuIE3rr58OVmwOdYIb0oYmSj0oAzx9rM7o2/ubvfai9HkjuKcCq2rcLaK4C24oLXGpT+h6uU1CV1KEEd8/grxYGypHY/zubAGy/tGOLyJB+kM/CAcgL3Y2x/ANgkQLejSXfnDCPcFh7M8eCg+8/NnEVPv8gWxA6HsDeR/nMC3GYeL+9HzMo1FmNO7hVAmO/jJg6zz1DmrVlBf2vuOSeMJx2Z2nI=" # DOCKER_PASS
    - COMMIT=${TRAVIS_COMMIT::8}
